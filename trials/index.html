<!DOCTYPE html>
<html lang="en">

<head>
    <title>Map Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="./images/reference.svg">

    <meta charset="UTF-8">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css"
        integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/styles.css">

    <!-- <link href="/static/lib/css/bootstrap.css" rel="stylesheet"> -->
    <link rel="stylesheet" type="text/css" href="/static/lib/css/dc.css" />
</head>

<body>

    <div class="container">
        <h1>Map Chart</h1>
        <script type="text/javascript" src="/trials/js/header.js"></script>

        <h2>US Venture Capital Landscape 2011</h2>

        <p>
            This example showing how GeoJson Polygon can be associated with
            crossfilter
            dimension and group using a choropleth chart. Different regions can be colored differently based on
            different
            calculation (amount raised). Like any other dc.js chart a choropleth chart can then be mixed with other
            dc.js
            chart
            or your own custom d3 drawing. In this example we have shown how it can work with multiple bubble chart.
        </p>

        <p>
            Public data source
            <a href="http://buzzdata.com/azad2002/the-united-states-of-venture-capital-2011#!/data"
                target="_blank">BuzzData.com</a>.
        </p>

        <div id="us-chart">
            <strong>VC Distribution by States (color: total amount raised)</strong>
            <a class="reset" href="javascript:usChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
            <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>

            <div class="clearfix"></div>
        </div>

        <div class="clearfix"></div>

        <div id="industry-chart">
            <strong>By Industries</strong> (y: number of deals, x: total amount raised in millions, radius: amount
            raised)
            <a class="reset" href="javascript:industryChart.filterAll();dc.redrawAll();"
                style="display: none;">reset</a>

            <div class="clearfix"></div>
        </div>

        <div class="clearfix"></div>

        <div id="round-chart">
            <strong>By Rounds</strong> (y: number of deals, x: total amount raised in millions, radius: amount raised)
            <a class="reset" href="javascript:roundChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

            <div class="clearfix"></div>
        </div>

        <div class="clearfix"></div>

        <div>
            <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
        </div>

    </div>

    <script type="text/javascript" src="/static/lib/js/d3.js"></script>
    <script type="text/javascript" src="/static/lib/js/crossfilter.js"></script>
    <script type="text/javascript" src="/static/lib/js/dc.js"></script>
    <script type="text/javascript">
        var numberFormat = d3.format(".2f");

        var usChart = new dc.GeoChoroplethChart("#us-chart");
        var industryChart = new dc.BubbleChart("#industry-chart");
        var roundChart = new dc.BubbleChart("#round-chart");

        d3.csv("vc.csv").then(function (csv) {
            var data = crossfilter(csv);

            var states = data.dimension(function (d) {
                return d["State"];
            });
            var stateRaisedSum = states.group().reduceSum(function (d) {
                return d["Raised"];
            });

            var industries = data.dimension(function (d) {
                return d["Industry Group"];
            });
            var statsByIndustries = industries.group().reduce(
                function (p, v) {
                    p.amountRaised += +v["Raised"];
                    p.deals += +v["Deals"];
                    return p;
                },
                function (p, v) {
                    p.amountRaised -= +v["Raised"];
                    if (p.amountRaised < 0.001) p.amountRaised = 0; // do some clean up
                    p.deals -= +v["Deals"];
                    return p;
                },
                function () {
                    return { amountRaised: 0, deals: 0 }
                }
            );

            var rounds = data.dimension(function (d) {
                return d["RoundClassDescr"];
            });
            var statsByRounds = rounds.group().reduce(
                function (p, v) {
                    p.amountRaised += +v["Raised"];
                    p.deals += +v["Deals"];
                    return p;
                },
                function (p, v) {
                    p.amountRaised -= +v["Raised"];
                    if (p.amountRaised < 0.001) p.amountRaised = 0; // do some clean up
                    p.deals -= +v["Deals"];
                    return p;
                },
                function () {
                    return { amountRaised: 0, deals: 0 }
                }
            );

            d3.json("../geo/us-states.json").then(function (statesJson) {
                usChart.width(990)
                    .height(500)
                    .dimension(states)
                    .group(stateRaisedSum)
                    .colors(d3.scaleQuantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, 200])
                    .colorCalculator(function (d) { return d ? usChart.colors()(d) : '#ccc'; })
                    .overlayGeoJson(statesJson.features, "state", function (d) {
                        return d.properties.name;
                    })
                    .projection(d3.geoAlbersUsa())
                    .valueAccessor(function (kv) {
                        console.log(kv);
                        return kv.value;
                    })
                    .title(function (d) {
                        return "State: " + d.key + "\nTotal Amount Raised: " + numberFormat(d.value ? d.value : 0) + "M";
                    });

                industryChart.width(990)
                    .height(200)
                    .margins({ top: 10, right: 50, bottom: 30, left: 60 })
                    .dimension(industries)
                    .group(statsByIndustries)
                    .colors(d3.scaleOrdinal(d3.schemeCategory10))
                    .keyAccessor(function (p) {
                        return p.value.amountRaised;
                    })
                    .valueAccessor(function (p) {
                        return p.value.deals;
                    })
                    .radiusValueAccessor(function (p) {
                        return p.value.amountRaised;
                    })
                    .x(d3.scaleLinear().domain([0, 5000]))
                    .r(d3.scaleLinear().domain([0, 4000]))
                    .minRadiusWithLabel(15)
                    .elasticY(true)
                    .yAxisPadding(100)
                    .elasticX(true)
                    .xAxisPadding(200)
                    .maxBubbleRelativeSize(0.07)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .title(function (p) {
                        return p.key
                            + "\n"
                            + "Amount Raised: " + numberFormat(p.value.amountRaised) + "M\n"
                            + "Number of Deals: " + numberFormat(p.value.deals);
                    });
                industryChart.yAxis().tickFormat(function (s) {
                    return s + " deals";
                });
                industryChart.xAxis().tickFormat(function (s) {
                    return s + "M";
                });

                roundChart.width(990)
                    .height(200)
                    .margins({ top: 10, right: 50, bottom: 30, left: 60 })
                    .dimension(rounds)
                    .group(statsByRounds)
                    .colors(d3.scaleOrdinal(d3.schemeCategory10))
                    .keyAccessor(function (p) {
                        return p.value.amountRaised;
                    })
                    .valueAccessor(function (p) {
                        return p.value.deals;
                    })
                    .radiusValueAccessor(function (p) {
                        return p.value.amountRaised;
                    })
                    .x(d3.scaleLinear().domain([0, 5000]))
                    .r(d3.scaleLinear().domain([0, 9000]))
                    .minRadiusWithLabel(15)
                    .elasticY(true)
                    .yAxisPadding(150)
                    .elasticX(true)
                    .xAxisPadding(300)
                    .maxBubbleRelativeSize(0.07)
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .renderLabel(true)
                    .renderTitle(true)
                    .title(function (p) {
                        return p.key
                            + "\n"
                            + "Amount Raised: " + numberFormat(p.value.amountRaised) + "M\n"
                            + "Number of Deals: " + numberFormat(p.value.deals);
                    });
                roundChart.yAxis().tickFormat(function (s) {
                    return s + " deals";
                });
                roundChart.xAxis().tickFormat(function (s) {
                    return s + "M";
                });

                dc.renderAll();
            });
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.1.1/js/all.js"
        integrity="sha384-BtvRZcyfv4r0x/phJt9Y9HhnN5ur1Z+kZbKVgzVBAlQZX4jvAuImlIz+bG7TS00a"
        crossorigin="anonymous"></script>
</body>

</html>